<!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel IPTV - Cloudflare Worker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f0f2f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }
    .form-control, .form-select {
      border-radius: 0.5rem;
    }
    .form-label {
      font-weight: 500;
    }
    .user-row {
      font-size: 0.95rem;
    }
    .link-box {
      white-space: nowrap;
      overflow-x: auto;
      font-size: 0.8rem;
      background: #f8f9fa;
      padding: 6px;
      border-radius: 0.3rem;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card">
      <div class="card-header bg-dark text-white">
        <h4 class="mb-0">Painel IPTV - Cloudflare</h4>
      </div>
      <div class="card-body">
        <form id="userForm" class="row g-3 mb-4">
          <div class="col-md-3">
            <label class="form-label">Usuário</label>
            <input type="text" id="username" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Senha</label>
            <input type="text" id="password" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Validade</label>
            <select id="validade" class="form-select">
              <option value="0">Ilimitado</option>
              <option value="21600">6 horas</option>
              <option value="43200">12 horas</option>
              <option value="86400">1 dia</option>
              <option value="604800">1 semana</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success w-100" type="submit">Adicionar usuário</button>
          </div>
        </form><h5 class="mt-4">Usuários Ativos</h5>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Usuário</th>
            <th>Senha</th>
            <th>Expira em</th>
            <th>Link M3U</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <div id="statusMsg" class="mt-3 text-center"></div>
  </div>
</div>

  </div>  <script>
    const workerName = "shiny-frog-756a";
    const accountId = "de758fbcc77916ba79a164714c7581bf";
    const apiToken = "1KQl88EvnwhizN2YuUeJ6mIUrO0LpGmp7WTbu5Ve";
    const apiUrl = `https://api.cloudflare.com/client/v4/accounts/${accountId}/workers/scripts/${workerName}`;

    async function getCurrentUsers() {
      const res = await fetch(apiUrl, {
        headers: { Authorization: `Bearer ${apiToken}` }
      });
      const code = await res.text();
      const match = code.match(/const users = ({[\s\S]*?})/);
      if (!match) return {};
      return eval(`(${match[1]})`);
    }

    async function updateUsers(usersObj) {
      const newCode = `const users = ${JSON.stringify(usersObj, null, 2)};\n\n// restante do seu código...`;
      const formData = new FormData();
      formData.append("script", new Blob([newCode], { type: "application/javascript" }), `${workerName}.js`);
      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: { Authorization: `Bearer ${apiToken}` },
        body: formData
      });
      return res.ok;
    }

    function gerarLink(usuario, senha) {
      return `https://shiny-frog-756a.luizfbs2011.workers.dev/get.php?username=${usuario}&password=${senha}&type=m3u_plus`;
    }

    function tempo(exp) {
      if (!exp || exp === 0) return "Ilimitado";
      const segundos = exp - Math.floor(Date.now() / 1000);
      if (segundos <= 0) return "<span class='text-danger'>Expirado</span>";
      const h = Math.floor(segundos / 3600);
      const m = Math.floor((segundos % 3600) / 60);
      return `${h}h ${m}min`;
    }

    async function atualizarTabela() {
      const tabela = document.getElementById("usersTable");
      tabela.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
      const users = await getCurrentUsers();
      tabela.innerHTML = "";
      Object.entries(users).forEach(([usuario, dados]) => {
        const exp = dados.expira_em || 0;
        tabela.innerHTML += `
          <tr class="user-row">
            <td>${usuario}</td>
            <td>${dados.senha}</td>
            <td>${tempo(exp)}</td>
            <td><div class="link-box">${gerarLink(usuario, dados.senha)}</div></td>
          </tr>
        `;
      });
    }

    document.getElementById("userForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const validade = parseInt(document.getElementById("validade").value);
      if (!username || !password) return;
      const users = await getCurrentUsers();
      users[username] = {
        senha: password,
        expira_em: validade > 0 ? Math.floor(Date.now() / 1000) + validade : 0
      };
      const sucesso = await updateUsers(users);
      document.getElementById("statusMsg").innerHTML = sucesso
        ? `<div class='alert alert-success'>Usuário <strong>${username}</strong> adicionado com sucesso.</div>`
        : `<div class='alert alert-danger'>Erro ao atualizar usuários.</div>`;
      atualizarTabela();
    });

    atualizarTabela();
  </script></body>
</html>
